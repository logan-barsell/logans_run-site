<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1"
    />
    <title>Loading...</title>
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="%PUBLIC_URL%/favicons/apple-touch-icon.png"
    />
    <link
      rel="manifest"
      href="%PUBLIC_URL%/favicons/site.webmanifest"
    />
    <script>
      // Fetch theme and set CSS variables before pace loads
      (function () {
        let theme = null;

        // Try to fetch theme with timeout and error handling for mobile
        try {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', '/api/theme', false);
          xhr.timeout = 3000; // 3 second timeout for mobile
          xhr.onerror = function () {
            console.warn('Theme fetch failed (network error)');
          };
          xhr.ontimeout = function () {
            console.warn('Theme fetch timed out');
          };
          xhr.send();

          if (xhr.status === 200 && xhr.responseText) {
            try {
              theme = JSON.parse(xhr.responseText);
            } catch (error) {
              console.warn('Theme parse failed:', error);
            }
          } else {
            console.warn('Theme fetch returned status:', xhr.status);
          }
        } catch (error) {
          console.warn('Theme fetch failed:', error);
        }

        // Only proceed if we have valid theme data
        if (theme && Object.keys(theme).length > 0) {
          // Update page title
          if (theme.siteTitle) {
            document.title = theme.siteTitle;
          }

          // Update favicon if bandLogoUrl is provided
          if (theme.bandLogoUrl) {
            console.log('🎯 Starting favicon update process...');

            // Remove existing favicon links
            const existingFavicons = document.querySelectorAll(
              'link[rel*="icon"], link[rel="apple-touch-icon"]'
            );
            console.log(
              '🗑️ Removing',
              existingFavicons.length,
              'existing favicon links'
            );
            existingFavicons.forEach(link => link.remove());

            // Add new favicon links with proper type detection and cache busting
            const cacheBuster = '?v=' + Date.now();

            console.log(
              '🔄 Setting favicon with cache buster:',
              theme.bandLogoUrl + cacheBuster
            );

            const faviconLink = document.createElement('link');
            faviconLink.rel = 'icon';

            // Detect image type from URL or default to png
            const imageType = theme.bandLogoUrl.match(
              /\.(jpg|jpeg|png|gif|svg|ico)$/i
            );
            faviconLink.type = imageType
              ? `image/${imageType[1]}`
              : 'image/png';
            faviconLink.href = theme.bandLogoUrl + cacheBuster;
            document.head.appendChild(faviconLink);

            // Add apple touch icon with cache busting
            const appleTouchIcon = document.createElement('link');
            appleTouchIcon.rel = 'apple-touch-icon';
            appleTouchIcon.href = theme.bandLogoUrl + cacheBuster;
            document.head.appendChild(appleTouchIcon);

            // Add shortcut icon for older browsers
            const shortcutIcon = document.createElement('link');
            shortcutIcon.rel = 'shortcut icon';
            shortcutIcon.href = theme.bandLogoUrl + cacheBuster;
            document.head.appendChild(shortcutIcon);

            // Add additional mobile-specific favicon links
            const appleTouchIconPrecomposed = document.createElement('link');
            appleTouchIconPrecomposed.rel = 'apple-touch-icon-precomposed';
            appleTouchIconPrecomposed.href = theme.bandLogoUrl + cacheBuster;
            document.head.appendChild(appleTouchIconPrecomposed);

            // Add 32x32 favicon specifically for mobile
            const favicon32 = document.createElement('link');
            favicon32.rel = 'icon';
            favicon32.type = 'image/png';
            favicon32.sizes = '32x32';
            favicon32.href = theme.bandLogoUrl + cacheBuster;
            document.head.appendChild(favicon32);

            // Add 16x16 favicon specifically for mobile
            const favicon16 = document.createElement('link');
            favicon16.rel = 'icon';
            favicon16.type = 'image/png';
            favicon16.sizes = '16x16';
            favicon16.href = theme.bandLogoUrl + cacheBuster;
            document.head.appendChild(favicon16);

            // Force favicon reload by temporarily removing and re-adding
            setTimeout(() => {
              // Remove all favicon links again
              const allFavicons = document.querySelectorAll(
                'link[rel*="icon"], link[rel="apple-touch-icon"]'
              );
              allFavicons.forEach(link => link.remove());

              // Re-add with new cache buster
              const newCacheBuster = '?v=' + (Date.now() + 1);

              const newFaviconLink = document.createElement('link');
              newFaviconLink.rel = 'icon';
              newFaviconLink.type = imageType
                ? `image/${imageType[1]}`
                : 'image/png';
              newFaviconLink.href = theme.bandLogoUrl + newCacheBuster;
              document.head.appendChild(newFaviconLink);

              const newAppleTouchIcon = document.createElement('link');
              newAppleTouchIcon.rel = 'apple-touch-icon';
              newAppleTouchIcon.href = theme.bandLogoUrl + newCacheBuster;
              document.head.appendChild(newAppleTouchIcon);

              const newShortcutIcon = document.createElement('link');
              newShortcutIcon.rel = 'shortcut icon';
              newShortcutIcon.href = theme.bandLogoUrl + newCacheBuster;
              document.head.appendChild(newShortcutIcon);

              const newAppleTouchIconPrecomposed =
                document.createElement('link');
              newAppleTouchIconPrecomposed.rel = 'apple-touch-icon-precomposed';
              newAppleTouchIconPrecomposed.href =
                theme.bandLogoUrl + newCacheBuster;
              document.head.appendChild(newAppleTouchIconPrecomposed);

              const newFavicon32 = document.createElement('link');
              newFavicon32.rel = 'icon';
              newFavicon32.type = 'image/png';
              newFavicon32.sizes = '32x32';
              newFavicon32.href = theme.bandLogoUrl + newCacheBuster;
              document.head.appendChild(newFavicon32);

              const newFavicon16 = document.createElement('link');
              newFavicon16.rel = 'icon';
              newFavicon16.type = 'image/png';
              newFavicon16.sizes = '16x16';
              newFavicon16.href = theme.bandLogoUrl + newCacheBuster;
              document.head.appendChild(newFavicon16);

              // Try converting to data URL as a last resort
              fetch(theme.bandLogoUrl)
                .then(response => response.blob())
                .then(blob => {
                  const reader = new FileReader();
                  reader.onloadend = function () {
                    const dataUrl = reader.result;

                    // Remove all favicon links one more time
                    const allFavicons = document.querySelectorAll(
                      'link[rel*="icon"], link[rel="apple-touch-icon"]'
                    );
                    allFavicons.forEach(link => link.remove());

                    // Add favicon using data URL
                    const dataFaviconLink = document.createElement('link');
                    dataFaviconLink.rel = 'icon';
                    dataFaviconLink.type = imageType
                      ? `image/${imageType[1]}`
                      : 'image/png';
                    dataFaviconLink.href = dataUrl;
                    document.head.appendChild(dataFaviconLink);

                    const dataAppleTouchIcon = document.createElement('link');
                    dataAppleTouchIcon.rel = 'apple-touch-icon';
                    dataAppleTouchIcon.href = dataUrl;
                    document.head.appendChild(dataAppleTouchIcon);

                    const dataShortcutIcon = document.createElement('link');
                    dataShortcutIcon.rel = 'shortcut icon';
                    dataShortcutIcon.href = dataUrl;
                    document.head.appendChild(dataShortcutIcon);

                    const dataAppleTouchIconPrecomposed =
                      document.createElement('link');
                    dataAppleTouchIconPrecomposed.rel =
                      'apple-touch-icon-precomposed';
                    dataAppleTouchIconPrecomposed.href = dataUrl;
                    document.head.appendChild(dataAppleTouchIconPrecomposed);
                  };
                  reader.readAsDataURL(blob);
                })
                .catch(error => {
                  console.warn('Failed to convert favicon to data URL:', error);
                });
            }, 100);
          }

          // Set CSS variables
          const root = document.documentElement;
          if (theme.primaryColor)
            root.style.setProperty('--main', theme.primaryColor);
          if (theme.secondaryColor)
            root.style.setProperty('--secondary', theme.secondaryColor);
          if (theme.primaryFont)
            root.style.setProperty('--primary-font', theme.primaryFont);

          if (theme.secondaryFont) {
            let fontStack = "'Courier New', Courier, monospace";
            switch (theme.secondaryFont) {
              case 'Fira Mono':
                fontStack = "'Fira Mono', 'Courier New', Courier, monospace";
                break;
              case 'JetBrains Mono':
                fontStack =
                  "'JetBrains Mono', 'Courier New', Courier, monospace";
                break;
              case 'Roboto Mono':
                fontStack = "'Roboto Mono', 'Courier New', Courier, monospace";
                break;
            }
            root.style.setProperty('--secondary-font', fontStack);
          }

          // Set basic pace options
          window.paceOptions = {
            eventLag: false,
            ajax: false,
            elements: { selectors: ['#root'] },
            restartOnRequestAfter: false,
            target: '#root',
            className: `pace-theme-${theme.paceTheme}`,
          };

          // Load the pace theme CSS from local files
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = `/themes/pace/${theme.paceTheme}.css`;
          document.head.appendChild(link);
        }
      })();
    </script>
    <script src="%PUBLIC_URL%/pace.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Sancreek"
      rel="stylesheet"
    />
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <div class="modal-container"></div>
    <div class="cart-container"></div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
